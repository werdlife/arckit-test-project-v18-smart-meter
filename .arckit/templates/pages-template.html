<!DOCTYPE html>
<html lang="en" class="govuk-template">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="Project documentation generated by ArcKit">
    <title>Project Documentation - ArcKit</title>

    <!-- GOV.UK Frontend -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/govuk-frontend@5.13.0/dist/govuk/govuk-frontend.min.css">

    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.6/marked.min.js"></script>

    <!-- Mermaid.js for Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js"></script>

    <style>
        /* CSS Variables for theming */
        :root {
            --sidebar-width: 300px;
            --sidebar-collapsed-width: 0px;
            --toc-width: 220px;
            --header-height: 50px;
            --primary-color: #1d70b8;
            --primary-dark: #003078;
            --background-light: #f3f2f1;
            --border-color: #b1b4b6;
            --text-muted: #505a5f;
            --transition-speed: 0.3s;
        }

        /* Font Override - GDS Transport only for *.gov.uk domains */
        body, .govuk-template, .govuk-template__body, [class*="govuk-"] {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                         Helvetica, Arial, sans-serif !important;
        }

        html {
            scroll-behavior: smooth;
        }

        /* Layout */
        .app-layout {
            display: flex;
            min-height: calc(100vh - var(--header-height) - 80px);
        }

        /* Sidebar */
        .app-sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--background-light);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: calc(100vh - var(--header-height));
            transition: width var(--transition-speed), min-width var(--transition-speed), transform var(--transition-speed);
            display: flex;
            flex-direction: column;
        }

        .app-sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
            min-width: var(--sidebar-collapsed-width);
            overflow: hidden;
        }

        .app-sidebar-header {
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .app-sidebar-header h2 {
            color: white;
            margin: 0;
            font-size: 1.1rem;
        }

        .app-sidebar-toggle {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .app-sidebar-toggle:hover {
            opacity: 1;
        }

        /* Search */
        .app-search {
            padding: 0.75rem 1rem;
            background: white;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .app-search-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .app-search-input:focus {
            outline: 3px solid #ffdd00;
            outline-offset: 0;
            border-color: #0b0c0c;
        }

        .app-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .app-search-results.visible {
            display: block;
        }

        .app-search-result {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--background-light);
        }

        .app-search-result:hover {
            background: var(--background-light);
        }

        .app-search-result-title {
            font-weight: 600;
        }

        .app-search-result-path {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Navigation */
        .app-nav-container {
            flex: 1;
            overflow-y: auto;
        }

        .app-nav-section {
            border-bottom: 1px solid var(--border-color);
        }

        .app-nav-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: #fff;
            cursor: pointer;
            font-weight: 700;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
        }

        .app-nav-section-header:hover {
            background: var(--background-light);
        }

        .app-nav-section-header .chevron {
            transition: transform 0.2s;
            font-size: 0.75rem;
        }

        .app-nav-section-header.collapsed .chevron {
            transform: rotate(-90deg);
        }

        .app-nav-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .app-nav-list li {
            margin: 0;
        }

        .app-nav-list a {
            display: block;
            padding: 0.5rem 1rem 0.5rem 1.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.875rem;
            border-left: 4px solid transparent;
            transition: background 0.15s, border-color 0.15s;
        }

        .app-nav-list a:hover {
            background: #fff;
            border-left-color: var(--primary-color);
        }

        .app-nav-list a.active {
            background: #fff;
            border-left-color: var(--primary-color);
            font-weight: 700;
        }

        .app-nav-category {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 0.5rem 1rem 0.25rem 1.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Main Content - Full Width, Left Aligned */
        .app-content-wrapper {
            flex: 1;
            display: flex;
            min-width: 0;
            position: relative;
        }

        .app-content {
            flex: 1;
            padding: 2rem 2rem 2rem 2.5rem;
            overflow-y: auto;
            min-width: 0;
        }

        .app-content-inner {
            max-width: 100%;
        }

        /* Table of Contents Sidebar (Left of Content) */
        .app-toc {
            width: var(--toc-width);
            min-width: var(--toc-width);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            font-size: 0.8125rem;
            background: var(--background-light);
        }

        .app-toc-title {
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .app-toc-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .app-toc-list li {
            margin: 0;
        }

        .app-toc-list a {
            display: block;
            padding: 0.25rem 0.75rem 0.25rem 0;
            color: var(--text-muted);
            text-decoration: none;
            border-right: 2px solid transparent;
            margin-right: -1rem;
            transition: color 0.15s, border-color 0.15s;
        }

        .app-toc-list a:hover {
            color: var(--primary-color);
        }

        .app-toc-list a.active {
            color: var(--primary-color);
            border-right-color: var(--primary-color);
        }

        .app-toc-list .toc-h3 {
            padding-left: 0.75rem;
            font-size: 0.75rem;
        }

        /* Document Header */
        .app-doc-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .app-doc-breadcrumb {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .app-doc-title {
            margin: 0;
            font-size: 2.25rem;
        }

        /* Loading State */
        .app-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .app-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--background-light);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .app-error {
            background: #f47738;
            color: white;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Welcome Screen */
        .app-welcome {
            text-align: left;
            padding: 2rem 0;
        }

        .app-welcome h1 {
            margin-bottom: 1rem;
        }

        .app-welcome p {
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 0 2rem 0;
        }

        .app-welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 900px;
            text-align: left;
        }

        .app-welcome-feature {
            background: var(--background-light);
            padding: 1.25rem;
            border-left: 4px solid var(--primary-color);
        }

        .app-welcome-feature h3 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
        }

        .app-welcome-feature p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Keyboard shortcuts help */
        .app-keyboard-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2rem;
            text-align: left;
        }

        .app-keyboard-hint kbd {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 0.125rem 0.375rem;
            font-family: inherit;
            font-size: 0.7rem;
        }

        /* Markdown Content Styles */
        .app-markdown h1 { font-size: 2rem; margin-top: 0; }
        .app-markdown h2 { font-size: 1.5rem; margin-top: 2.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; scroll-margin-top: 1rem; }
        .app-markdown h3 { font-size: 1.25rem; margin-top: 2rem; scroll-margin-top: 1rem; }
        .app-markdown h4 { font-size: 1.1rem; margin-top: 1.5rem; }

        .app-markdown p { margin: 1rem 0; line-height: 1.6; }

        .app-markdown ul, .app-markdown ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .app-markdown li { margin: 0.5rem 0; line-height: 1.5; }

        .app-markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }

        .app-markdown th, .app-markdown td {
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            text-align: left;
        }

        .app-markdown th {
            background: var(--background-light);
            font-weight: 700;
        }

        .app-markdown tr:hover {
            background: #fafafa;
        }

        .app-markdown code {
            background: var(--background-light);
            padding: 0.125rem 0.375rem;
            font-family: 'SF Mono', 'Consolas', 'Liberation Mono', monospace;
            font-size: 0.875em;
            border-radius: 2px;
        }

        .app-markdown pre {
            background: #0b0c0c;
            color: #fff;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: 0;
        }

        .app-markdown pre code {
            background: none;
            padding: 0;
            color: inherit;
            border-radius: 0;
        }

        .app-markdown blockquote {
            border-left: 4px solid var(--primary-color);
            margin: 1.5rem 0;
            padding: 0.75rem 1.25rem;
            background: var(--background-light);
        }

        .app-markdown blockquote p:first-child {
            margin-top: 0;
        }

        .app-markdown blockquote p:last-child {
            margin-bottom: 0;
        }

        .app-markdown a {
            color: var(--primary-color);
        }

        .app-markdown img {
            max-width: 100%;
            height: auto;
        }

        .app-markdown hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 2rem 0;
        }

        /* Mermaid Diagrams - Full Width */
        .app-markdown .mermaid {
            background: #fff;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border-color);
            text-align: center;
            overflow-x: auto;
        }

        .app-markdown .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        /* Mobile header hamburger button */
        .app-mobile-menu {
            display: none;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }

        /* Mobile sidebar backdrop */
        .app-sidebar-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            top: var(--header-height);
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .app-sidebar-backdrop.visible {
            display: block;
        }

        /* Sidebar expand button (visible when collapsed) */
        .app-sidebar-expand {
            display: none;
            position: fixed;
            left: 0;
            top: calc(var(--header-height) + 1rem);
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            z-index: 99;
            border-radius: 0 4px 4px 0;
        }

        .app-sidebar.collapsed ~ .app-content-wrapper .app-sidebar-expand {
            display: block;
        }

        /* Header */
        .app-header {
            background: #0b0c0c;
            height: var(--header-height);
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .app-header__container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            width: 100%;
        }

        .app-header__left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .app-header__link {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            text-decoration: none;
        }

        .app-header__link:hover {
            text-decoration: underline;
        }

        .app-header__nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .app-header__nav a,
        .app-header__stats {
            color: #b1b4b6;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .app-header__nav a:hover {
            color: white;
            text-decoration: underline;
        }

        /* Footer */
        .app-footer {
            background: var(--background-light);
            padding: 1.5rem 0;
            border-top: 1px solid var(--border-color);
        }

        .app-footer-inner {
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .app-footer a {
            color: var(--primary-color);
        }

        /* Stats */
        .app-header__stats .app-stat-value {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-toc {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .app-sidebar {
                position: fixed;
                left: calc(-1 * var(--sidebar-width));
                top: var(--header-height);
                z-index: 100;
                height: calc(100vh - var(--header-height));
                transition: left var(--transition-speed);
                box-shadow: none;
            }

            .app-sidebar.open {
                left: 0;
                box-shadow: 2px 0 8px rgba(0,0,0,0.15);
            }

            .app-sidebar.collapsed {
                left: calc(-1 * var(--sidebar-width));
            }

            .app-mobile-menu {
                display: block;
            }

            .app-sidebar-expand {
                display: none !important;
            }

            .app-content {
                padding: 1.5rem;
            }

            .app-header__nav a {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .app-content {
                padding: 1rem;
            }

            .app-doc-title {
                font-size: 1.25rem;
            }

            .app-markdown h1 {
                font-size: 1.25rem;
            }

            .app-welcome h1 {
                font-size: 1.25rem;
            }

            .app-welcome-features {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            .app-sidebar, .app-mobile-menu, .app-header, .app-footer, .app-toc, .app-sidebar-expand, .app-sidebar-backdrop {
                display: none !important;
            }

            .app-content {
                padding: 0;
                max-width: 100%;
            }

            .app-markdown .mermaid {
                page-break-inside: avoid;
            }
        }

        /* Focus styles for accessibility */
        *:focus-visible {
            outline: 3px solid #ffdd00;
            outline-offset: 0;
        }
    </style>
</head>
<body class="govuk-template__body">
    <!-- Skip Link -->
    <a href="#main-content" class="govuk-skip-link">Skip to main content</a>

    <!-- Header -->
    <header class="app-header">
        <div class="app-header__container">
            <div class="app-header__left">
                <button class="app-mobile-menu" id="mobile-menu" aria-label="Open navigation menu">&#9776;</button>
                <a href="#" class="app-header__link" id="header-title">Project Documentation</a>
            </div>
            <nav class="app-header__nav" aria-label="Site navigation">
                <span class="app-header__stats" id="header-stats"></span>
                <a href="https://github.com/{{OWNER}}/{{REPO}}" target="_blank" rel="noopener">GitHub</a>
                <a href="https://tractorjuice.github.io/arc-kit/">ArcKit</a>
            </nav>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <nav class="app-sidebar" id="sidebar" aria-label="Document navigation">
            <div class="app-sidebar-header">
                <h2>Documents</h2>
                <button class="app-sidebar-toggle" id="sidebar-toggle" aria-label="Collapse sidebar" title="Collapse sidebar (Ctrl+B)">
                    ◀
                </button>
            </div>
            <div class="app-search" id="search-container">
                <input type="search" class="app-search-input" id="search-input" placeholder="Search documents... (Ctrl+K)" aria-label="Search documents">
                <div class="app-search-results" id="search-results"></div>
            </div>
            <div class="app-nav-container" id="nav-container">
                <!-- Navigation will be populated by JavaScript -->
                <div class="app-loading">
                    <div class="app-spinner"></div>
                    Loading...
                </div>
            </div>
        </nav>

        <!-- Mobile sidebar backdrop -->
        <div class="app-sidebar-backdrop" id="sidebar-backdrop"></div>

        <!-- Content Wrapper -->
        <div class="app-content-wrapper">
            <!-- Sidebar expand button -->
            <button class="app-sidebar-expand" id="sidebar-expand" aria-label="Expand sidebar">
                ▶
            </button>

            <!-- Table of Contents (Left Side) -->
            <aside class="app-toc" id="toc" aria-label="Table of contents">
                <div class="app-toc-title">On this page</div>
                <ul class="app-toc-list" id="toc-list">
                    <!-- Populated by JavaScript -->
                </ul>
            </aside>

            <!-- Main Content -->
            <main class="app-content" id="main-content">
                <div class="app-content-inner" id="content">
                    <div class="app-welcome">
                        <h1>Welcome</h1>
                        <p>Select a document from the navigation menu to view its contents. This documentation site supports Mermaid diagrams, full-text search, and keyboard navigation.</p>
                        <div class="app-welcome-features">
                            <div class="app-welcome-feature">
                                <h3>Search</h3>
                                <p>Use the search bar or press Ctrl+K to quickly find documents.</p>
                            </div>
                            <div class="app-welcome-feature">
                                <h3>Navigation</h3>
                                <p>Browse by project or category in the sidebar. Use arrow keys to navigate.</p>
                            </div>
                            <div class="app-welcome-feature">
                                <h3>Diagrams</h3>
                                <p>Mermaid diagrams render automatically with full interactivity.</p>
                            </div>
                            <div class="app-welcome-feature">
                                <h3>Table of Contents</h3>
                                <p>Long documents show a table of contents for easy navigation.</p>
                            </div>
                        </div>
                        <p class="app-keyboard-hint">
                            <kbd>Ctrl</kbd>+<kbd>K</kbd> Search &nbsp;&nbsp;
                            <kbd>Ctrl</kbd>+<kbd>B</kbd> Toggle sidebar &nbsp;&nbsp;
                            <kbd>Esc</kbd> Close search
                        </p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="app-footer-inner">
            <span>Generated by <a href="https://github.com/tractorjuice/arc-kit" target="_blank">ArcKit</a></span>
            <span id="footer-generated"></span>
        </div>
    </footer>

    <script>
        // ============================================
        // Configuration - UPDATE THESE VALUES
        // ============================================
        const CONFIG = {
            owner: '{{OWNER}}',           // GitHub username/org
            repo: '{{REPO}}',             // Repository name
            branch: '{{BRANCH}}'          // Branch name (usually 'main')
        };

        // ============================================
        // State
        // ============================================
        let manifest = null;
        let documentCache = new Map();
        let allDocuments = [];
        let currentTocObserver = null;

        // ============================================
        // Utilities
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getRawUrl(path) {
            return `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/${path}`;
        }

        function getDocumentId(path) {
            return path.replace(/[^a-zA-Z0-9]/g, '-');
        }

        function extractTitle(path) {
            const filename = path.split('/').pop().replace('.md', '');
            return filename
                .replace(/-/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function debounce(fn, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        // ============================================
        // Marked Configuration
        // ============================================
        const renderer = new marked.Renderer();

        renderer.code = function(code, language) {
            // Handle object input (newer marked versions)
            if (typeof code === 'object') {
                language = code.lang;
                code = code.text;
            }

            if (language === 'mermaid') {
                return `<pre class="mermaid">${escapeHtml(code)}</pre>`;
            }
            const langClass = language ? `language-${language}` : '';
            return `<pre><code class="${langClass}">${escapeHtml(code)}</code></pre>`;
        };

        // Add IDs to headings for ToC links
        renderer.heading = function(text, level) {
            // Handle object input (newer marked versions)
            if (typeof text === 'object') {
                level = text.depth;
                text = text.text;
            }
            const id = text.toLowerCase().replace(/[^\w]+/g, '-');
            return `<h${level} id="${id}">${text}</h${level}>`;
        };

        marked.setOptions({
            renderer: renderer,
            gfm: true,
            breaks: false
        });

        // ============================================
        // Mermaid Configuration
        // ============================================
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: true },
            sequence: { useMaxWidth: true }
        });

        // ============================================
        // Search Functionality
        // ============================================
        function buildSearchIndex(manifest) {
            allDocuments = [];

            // Add global documents
            if (manifest.global) {
                manifest.global.forEach(doc => {
                    allDocuments.push({
                        ...doc,
                        searchText: `${doc.title} ${doc.category || ''} global`.toLowerCase()
                    });
                });
            }

            // Add project documents
            if (manifest.projects) {
                manifest.projects.forEach(project => {
                    const projectName = project.name || project.id;

                    if (project.documents) {
                        project.documents.forEach(doc => {
                            allDocuments.push({
                                ...doc,
                                project: projectName,
                                searchText: `${doc.title} ${doc.category || ''} ${projectName}`.toLowerCase()
                            });
                        });
                    }

                    if (project.diagrams) {
                        project.diagrams.forEach(doc => {
                            allDocuments.push({
                                ...doc,
                                project: projectName,
                                category: 'Diagrams',
                                searchText: `${doc.title} diagrams ${projectName}`.toLowerCase()
                            });
                        });
                    }

                    if (project.decisions) {
                        project.decisions.forEach(doc => {
                            allDocuments.push({
                                ...doc,
                                project: projectName,
                                category: 'Decisions',
                                searchText: `${doc.title} decisions adr ${projectName}`.toLowerCase()
                            });
                        });
                    }

                    if (project.vendors) {
                        project.vendors.forEach(vendor => {
                            if (vendor.documents) {
                                vendor.documents.forEach(doc => {
                                    allDocuments.push({
                                        ...doc,
                                        project: projectName,
                                        vendor: vendor.name,
                                        searchText: `${doc.title} ${vendor.name} vendor ${projectName}`.toLowerCase()
                                    });
                                });
                            }
                        });
                    }
                });
            }
        }

        function searchDocuments(query) {
            if (!query || query.length < 2) return [];

            const terms = query.toLowerCase().split(/\s+/);
            return allDocuments
                .filter(doc => terms.every(term => doc.searchText.includes(term)))
                .slice(0, 10);
        }

        function setupSearch() {
            const input = document.getElementById('search-input');
            const results = document.getElementById('search-results');

            const doSearch = debounce(() => {
                const query = input.value.trim();
                const matches = searchDocuments(query);

                if (matches.length === 0) {
                    results.classList.remove('visible');
                    return;
                }

                results.innerHTML = matches.map(doc => `
                    <div class="app-search-result" data-path="${doc.path}">
                        <div class="app-search-result-title">${doc.title}</div>
                        <div class="app-search-result-path">${doc.project ? doc.project + ' / ' : ''}${doc.category || 'Document'}</div>
                    </div>
                `).join('');

                results.classList.add('visible');

                // Add click handlers
                results.querySelectorAll('.app-search-result').forEach(el => {
                    el.addEventListener('click', () => {
                        const path = el.dataset.path;
                        window.location.hash = path;
                        loadDocument(path);
                        input.value = '';
                        results.classList.remove('visible');

                        // Update active state
                        document.querySelectorAll('#nav-container a').forEach(a => {
                            a.classList.toggle('active', a.dataset.path === path);
                        });

                        // Close mobile sidebar
                        closeMobileSidebar();
                    });
                });
            }, 150);

            input.addEventListener('input', doSearch);

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    input.value = '';
                    results.classList.remove('visible');
                    input.blur();
                }
            });

            // Close results when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#search-container')) {
                    results.classList.remove('visible');
                }
            });
        }

        // ============================================
        // Table of Contents
        // ============================================
        function buildTableOfContents(container) {
            const toc = document.getElementById('toc');
            const tocList = document.getElementById('toc-list');
            const headings = container.querySelectorAll('h2, h3');

            if (headings.length < 2) {
                toc.style.display = 'none';
                return;
            }

            toc.style.display = '';
            tocList.innerHTML = '';

            headings.forEach(heading => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${heading.id}`;
                a.textContent = heading.textContent;
                if (heading.tagName === 'H3') {
                    a.classList.add('toc-h3');
                }
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    heading.scrollIntoView({ behavior: 'smooth' });
                });
                li.appendChild(a);
                tocList.appendChild(li);
            });

            // Setup intersection observer for active state
            if (currentTocObserver) {
                currentTocObserver.disconnect();
            }

            currentTocObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        tocList.querySelectorAll('a').forEach(a => {
                            a.classList.toggle('active', a.getAttribute('href') === `#${id}`);
                        });
                    }
                });
            }, { rootMargin: '-20% 0px -70% 0px' });

            headings.forEach(heading => currentTocObserver.observe(heading));
        }

        // ============================================
        // Navigation Building
        // ============================================
        function buildNavigation(manifest) {
            const container = document.getElementById('nav-container');
            let html = '';

            // Global documents
            if (manifest.global && manifest.global.length > 0) {
                html += buildNavSection('Global', manifest.global, 'global');
            }

            // Projects
            if (manifest.projects) {
                manifest.projects.forEach(project => {
                    html += buildProjectNav(project);
                });
            }

            container.innerHTML = html;

            // Add click handlers for section headers
            container.querySelectorAll('.app-nav-section-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    const list = header.nextElementSibling;
                    list.style.display = header.classList.contains('collapsed') ? 'none' : 'block';
                });
            });

            // Add click handlers for document links
            container.querySelectorAll('a[data-path]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const path = link.dataset.path;
                    window.location.hash = path;
                    loadDocument(path);

                    // Update active state
                    container.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                    link.classList.add('active');

                    // Close mobile sidebar
                    closeMobileSidebar();
                });
            });
        }

        function buildNavSection(title, documents, sectionId) {
            if (!documents || documents.length === 0) return '';

            // Group by category
            const byCategory = {};
            documents.forEach(doc => {
                const cat = doc.category || 'Other';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(doc);
            });

            let listHtml = '';
            Object.keys(byCategory).forEach(category => {
                listHtml += `<li class="app-nav-category">${category}</li>`;
                byCategory[category].forEach(doc => {
                    listHtml += `<li><a href="#${doc.path}" data-path="${doc.path}">${doc.title}</a></li>`;
                });
            });

            return `
                <div class="app-nav-section">
                    <button class="app-nav-section-header">
                        ${title}
                        <span class="chevron">&#9660;</span>
                    </button>
                    <ul class="app-nav-list">${listHtml}</ul>
                </div>
            `;
        }

        function buildProjectNav(project) {
            let listHtml = '';

            // Main documents by category
            if (project.documents) {
                const byCategory = {};
                project.documents.forEach(doc => {
                    const cat = doc.category || 'Other';
                    if (!byCategory[cat]) byCategory[cat] = [];
                    byCategory[cat].push(doc);
                });

                Object.keys(byCategory).forEach(category => {
                    listHtml += `<li class="app-nav-category">${category}</li>`;
                    byCategory[category].forEach(doc => {
                        listHtml += `<li><a href="#${doc.path}" data-path="${doc.path}">${doc.title}</a></li>`;
                    });
                });
            }

            // Diagrams
            if (project.diagrams && project.diagrams.length > 0) {
                listHtml += `<li class="app-nav-category">Diagrams</li>`;
                project.diagrams.forEach(doc => {
                    listHtml += `<li><a href="#${doc.path}" data-path="${doc.path}">${doc.title}</a></li>`;
                });
            }

            // Decisions (ADRs)
            if (project.decisions && project.decisions.length > 0) {
                listHtml += `<li class="app-nav-category">Decisions</li>`;
                project.decisions.forEach(doc => {
                    listHtml += `<li><a href="#${doc.path}" data-path="${doc.path}">${doc.title}</a></li>`;
                });
            }

            // Vendors
            if (project.vendors && project.vendors.length > 0) {
                listHtml += `<li class="app-nav-category">Vendors</li>`;
                project.vendors.forEach(vendor => {
                    if (vendor.documents) {
                        vendor.documents.forEach(doc => {
                            listHtml += `<li><a href="#${doc.path}" data-path="${doc.path}">${vendor.name}: ${doc.title}</a></li>`;
                        });
                    }
                });
            }

            const displayName = project.name || project.id;
            return `
                <div class="app-nav-section">
                    <button class="app-nav-section-header">
                        ${displayName}
                        <span class="chevron">&#9660;</span>
                    </button>
                    <ul class="app-nav-list">${listHtml}</ul>
                </div>
            `;
        }

        // ============================================
        // Document Loading
        // ============================================
        async function loadDocument(path) {
            const content = document.getElementById('content');
            const toc = document.getElementById('toc');

            // Hide TOC while loading
            toc.style.display = 'none';

            // Show loading
            content.innerHTML = `
                <div class="app-loading">
                    <div class="app-spinner"></div>
                    Loading document...
                </div>
            `;

            try {
                let markdown;

                // Check cache
                if (documentCache.has(path)) {
                    markdown = documentCache.get(path);
                } else {
                    const response = await fetch(getRawUrl(path));
                    if (!response.ok) {
                        throw new Error(`Failed to load document: ${response.status}`);
                    }
                    markdown = await response.text();
                    documentCache.set(path, markdown);
                }

                // Extract title from first H1 or filename
                let title = extractTitle(path);
                const h1Match = markdown.match(/^#\s+(.+)$/m);
                if (h1Match) {
                    title = h1Match[1];
                    // Remove the first H1 from markdown to avoid duplicate title
                    markdown = markdown.replace(/^#\s+.+$/m, '').trimStart();
                }

                // Build breadcrumb
                const parts = path.split('/');
                const breadcrumb = parts.slice(0, -1).join(' / ');

                // Render markdown
                const html = marked.parse(markdown);

                content.innerHTML = `
                    <div class="app-doc-header">
                        <div class="app-doc-breadcrumb">${breadcrumb}</div>
                        <h1 class="app-doc-title">${title}</h1>
                    </div>
                    <div class="app-markdown">${html}</div>
                `;

                // Build table of contents
                buildTableOfContents(content.querySelector('.app-markdown'));

                // Render mermaid diagrams
                await mermaid.run({ querySelector: '.mermaid' });

                // Scroll to top
                document.getElementById('main-content').scrollTo(0, 0);

            } catch (error) {
                content.innerHTML = `
                    <div class="app-error">
                        <strong>Error loading document</strong><br>
                        ${error.message}
                    </div>
                    <p>Path: ${path}</p>
                    <p><a href="${getRawUrl(path)}" target="_blank">Try opening directly</a></p>
                `;
            }
        }

        // ============================================
        // Sidebar Toggle
        // ============================================
        function setupSidebarToggle() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const expandBtn = document.getElementById('sidebar-expand');

            function toggleSidebar() {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                toggleBtn.innerHTML = isCollapsed ? '&#9654;' : '&#9664;';
                toggleBtn.setAttribute('aria-label', isCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
            }

            toggleBtn.addEventListener('click', toggleSidebar);
            expandBtn.addEventListener('click', toggleSidebar);
        }

        // ============================================
        // Keyboard Shortcuts
        // ============================================
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+K - Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('search-input').focus();
                }

                // Ctrl+B - Toggle sidebar
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    document.getElementById('sidebar-toggle').click();
                }

                // Escape - Close search
                if (e.key === 'Escape') {
                    const searchInput = document.getElementById('search-input');
                    if (document.activeElement === searchInput) {
                        searchInput.blur();
                        document.getElementById('search-results').classList.remove('visible');
                    }
                }
            });
        }

        // ============================================
        // Initialization
        // ============================================
        async function init() {
            // Update header
            document.getElementById('header-title').textContent = `${CONFIG.repo} Documentation`;

            try {
                // Load manifest
                const response = await fetch('manifest.json');
                if (!response.ok) {
                    throw new Error('manifest.json not found');
                }
                manifest = await response.json();

                // Update footer
                if (manifest.generated) {
                    const date = new Date(manifest.generated);
                    document.getElementById('footer-generated').textContent =
                        `Generated: ${date.toLocaleDateString()}`;
                }

                // Update header stats
                const totalDocs = allDocuments.length || countDocuments(manifest);
                const projectCount = manifest.projects ? manifest.projects.length : 0;
                document.getElementById('header-stats').innerHTML =
                    `<span class="app-stat-value">${totalDocs}</span> docs · <span class="app-stat-value">${projectCount}</span> projects`;

                // Build search index
                buildSearchIndex(manifest);

                // Build navigation
                buildNavigation(manifest);

                // Setup search
                setupSearch();

                // Setup sidebar toggle
                setupSidebarToggle();

                // Setup keyboard shortcuts
                setupKeyboardShortcuts();

                // Handle initial hash
                if (window.location.hash) {
                    const path = window.location.hash.slice(1);
                    loadDocument(path);

                    // Mark as active
                    const link = document.querySelector(`a[data-path="${path}"]`);
                    if (link) link.classList.add('active');
                }

            } catch (error) {
                document.getElementById('nav-container').innerHTML = `
                    <div class="app-error">
                        Failed to load manifest: ${error.message}
                    </div>
                `;
            }
        }

        function countDocuments(manifest) {
            let count = 0;
            if (manifest.global) count += manifest.global.length;
            if (manifest.projects) {
                manifest.projects.forEach(p => {
                    if (p.documents) count += p.documents.length;
                    if (p.diagrams) count += p.diagrams.length;
                    if (p.decisions) count += p.decisions.length;
                    if (p.vendors) {
                        p.vendors.forEach(v => {
                            if (v.documents) count += v.documents.length;
                        });
                    }
                });
            }
            return count;
        }

        // Mobile menu toggle (header hamburger + backdrop)
        function openMobileSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebar-backdrop').classList.add('visible');
        }

        function closeMobileSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-backdrop').classList.remove('visible');
        }

        document.getElementById('mobile-menu').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                closeMobileSidebar();
            } else {
                openMobileSidebar();
            }
        });

        document.getElementById('sidebar-backdrop').addEventListener('click', closeMobileSidebar);

        // Hash change handler
        window.addEventListener('hashchange', () => {
            const path = window.location.hash.slice(1);
            if (path) {
                loadDocument(path);

                // Update active state
                document.querySelectorAll('#nav-container a').forEach(a => {
                    a.classList.toggle('active', a.dataset.path === path);
                });
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
